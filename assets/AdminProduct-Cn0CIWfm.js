import{r as o,k as e}from"./vendor-1KhO9Br4.js";import{a as L}from"./vendor-router-BuaAtQMK.js";import{a as p}from"./vendor-axios-B9ygI19o.js";import{M as E}from"./vendor-bootstrap-CjPjBXCY.js";import{a as A,u as P}from"./index-C_e115xw.js";import"./vendor-redux-jjwltitj.js";const F={"title 屬性不得為空":"【商品名稱】不得空白","category 屬性不得為空":"【分類】不得空白","unit 屬性不得為空":"【單位】不得空白"},S=c=>String(c).split(",").map(l=>l.trim()).filter(Boolean).map(l=>F[l]||l).join("、"),M="https://ec-course-api.hexschool.io/v2",_="kentlee406";function D({mode:c,tempProduct:l,getProductData:u}){const{showLoading:m,hideLoading:x}=o.useContext(A),{showNotification:r}=P(),[s,d]=o.useState({...l,imagesUrl:l.imagesUrl||["","","",""]}),[n,j]=o.useState(""),[v,y]=o.useState(!1),f=o.useRef(null),g=o.useRef(null);o.useEffect(()=>{const a=l.imagesUrl?[...l.imagesUrl]:[];for(;a.length<4;)a.push("");d({...l,imagesUrl:a})},[l]),o.useEffect(()=>(f.current&&(g.current=new E(f.current,{backdrop:"static"})),()=>{g.current&&g.current.dispose()}),[]);const h=a=>{const{id:t,value:i,type:b,checked:w}=a.target;d(U=>({...U,[t]:b==="checkbox"?w?1:0:b==="number"?Number(i):i}))},N=async a=>{const t=a.target.files?.[0];if(!t)return;const i=new FormData;i.append("file-to-upload",t);try{y(!0),m();const w=(await p.post(`${M}/api/${_}/admin/upload`,i)).data?.imageUrl;if(!w)throw new Error("上傳成功但未取得圖片網址");d(U=>({...U,imageUrl:w})),r("主圖上傳成功","success",6e3)}catch(b){r("主圖上傳失敗："+(b.response?.data?.message||b.message||"未知錯誤"),"error",8e3)}finally{y(!1),x(),a.target.value=""}},k=()=>{if(!n.trim())return;const a=[...s.imagesUrl],t=a.findIndex(i=>i==="");t!==-1?(a[t]=n,d(i=>({...i,imagesUrl:a})),j("")):alert("最多只能上傳 4 張圖片")},I=a=>{const t=[...s.imagesUrl];t[a]="",d(i=>({...i,imagesUrl:t}))},C=async()=>{try{m();const a=c==="create"?`${M}/api/${_}/admin/product`:`${M}/api/${_}/admin/product/${s.id}`;await p[c==="create"?"post":"put"](a,{data:s}),r(c==="create"?"新增成功":"更新成功","success",6e3),await u(),g.current.hide()}catch(a){const t=S(a.response?.data?.message||"未知錯誤");r("操作失敗："+t,"error",8e3)}finally{x()}};return e.jsx("div",{className:"modal fade ",ref:f,id:"ProductModal",tabIndex:"-1","aria-labelledby":"exampleModalLabel","aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title",children:"新增產品"}),e.jsx("button",{type:"button",className:"btn-close","data-bs-dismiss":"modal"})]}),e.jsx("div",{className:"modal-body",children:e.jsx("div",{className:"container",children:e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-lg-7",children:e.jsxs("form",{children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"title",className:"form-label fw-bold",children:"商品名稱"}),e.jsx("input",{type:"text",className:"form-control",id:"title",placeholder:"請輸入商品名稱",value:s.title||"",onChange:h})]}),e.jsxs("div",{className:"row mb-3",children:[e.jsxs("div",{className:"col-6",children:[e.jsx("label",{htmlFor:"origin_price",className:"form-label fw-bold",children:"原價"}),e.jsx("input",{type:"number",className:"form-control",id:"origin_price",min:"0",value:s.origin_price??0,onChange:h})]}),e.jsxs("div",{className:"col-6",children:[e.jsx("label",{htmlFor:"price",className:"form-label fw-bold",children:"售價"}),e.jsx("input",{type:"number",className:"form-control",id:"price",min:"0",value:s.price??0,onChange:h})]})]}),e.jsxs("div",{className:"row mb-3",children:[e.jsxs("div",{className:"col-6",children:[e.jsx("label",{htmlFor:"category",className:"form-label fw-bold",children:"分類"}),e.jsx("input",{type:"text",className:"form-control",id:"category",value:s.category||"",onChange:h})]}),e.jsxs("div",{className:"col-6",children:[e.jsx("label",{htmlFor:"unit",className:"form-label fw-bold",children:"單位"}),e.jsx("input",{type:"text",className:"form-control",id:"unit",value:s.unit||"",onChange:h})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"content",className:"form-label fw-bold",children:"商品內容"}),e.jsx("textarea",{className:"form-control",id:"content",rows:"4",value:s.content||"",onChange:h})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"description",className:"form-label fw-bold",children:"商品描述"}),e.jsx("textarea",{className:"form-control",id:"description",rows:"4",value:s.description||"",onChange:h})]}),e.jsxs("div",{className:"form-check form-switch",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"is_enabled",checked:!!s.is_enabled,onChange:h}),e.jsx("label",{className:"form-check-label fw-bold",htmlFor:"is_enabled",children:"啟用"})]})]})}),e.jsxs("div",{className:"col-lg-5",children:[e.jsx("label",{htmlFor:"mainImageUpload",className:"form-label fw-bold",children:"商品主圖（檔案上傳）"}),e.jsx("input",{type:"file",className:"form-control mb-2",id:"mainImageUpload",accept:"image/*",onChange:N,disabled:v}),v&&e.jsx("small",{className:"text-muted d-block mb-2",children:"主圖上傳中..."}),s.imageUrl?e.jsx("div",{className:"border rounded bg-light d-flex align-items-center justify-content-center mb-3",style:{height:"160px",overflow:"hidden"},children:e.jsx("img",{src:s.imageUrl,alt:"主圖預覽",className:"w-100 h-100 object-fit-cover",onError:a=>{a.target.src="https://via.placeholder.com/300x160?text=Invalid+Image"}})}):e.jsx("small",{className:"text-muted d-block mb-3",children:"尚未上傳主圖"}),e.jsx("label",{className:"form-label fw-bold",children:"其他圖片 (最多 4 張)"}),e.jsxs("div",{className:"input-group mb-3",children:[e.jsx("input",{type:"text",className:"form-control",placeholder:"輸入圖片連結",value:n,onChange:a=>j(a.target.value)}),e.jsx("button",{className:"btn btn-outline-primary",type:"button",onClick:k,children:"新增連結"})]}),e.jsx("div",{className:"row g-2",children:s.imagesUrl.map((a,t)=>e.jsx("div",{className:"col-6",children:e.jsx("div",{className:"border rounded bg-light d-flex align-items-center justify-content-center position-relative",style:{height:"100px",overflow:"hidden"},children:a?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:a,alt:"預覽圖",className:"w-100 h-100 object-fit-cover",onError:i=>{i.target.src="https://via.placeholder.com/150?text=Invalid+URL"}}),e.jsx("button",{type:"button",className:"btn btn-danger btn-sm position-absolute top-0 end-0 p-1",style:{fontSize:"10px",lineHeight:1},onClick:()=>I(t),children:"✕"})]}):e.jsxs("small",{className:"text-muted",children:["圖片 ",t+1]})})},t))})]})]})})}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-secondary","data-bs-dismiss":"modal",children:"關閉"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:C,children:"存檔"})]})]})})})}const T="https://ec-course-api.hexschool.io/v2",z="kentlee406";function B({getProductData:c,tempProduct:l}){const{showLoading:u,hideLoading:m}=o.useContext(A),{showNotification:x}=P(),r=async()=>{try{u(),await p.delete(`${T}/api/${z}/admin/product/${l.id}`),x("刪除成功","success",6e3),await c()}catch(s){const d=S(s.response?.data?.message||"發生錯誤");x(`刪除失敗：${d}`,"error",8e3)}finally{m()}};return e.jsx("div",{className:"modal fade",id:"deleteModal",tabIndex:"-1","aria-labelledby":"deleteModalLabel","aria-hidden":"true",children:e.jsx("div",{className:"modal-dialog",children:e.jsxs("div",{className:"modal-content border-0",children:[e.jsxs("div",{className:"modal-header bg-danger text-white",children:[e.jsx("h5",{className:"modal-title",id:"deleteModalLabel",children:e.jsx("span",{children:"刪除產品"})}),e.jsx("button",{type:"button",className:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})]}),e.jsxs("div",{className:"modal-body",children:["是否刪除",e.jsxs("strong",{className:"text-danger",children:[" ",l.title," "]}),"(刪除後將無法恢復)。"]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary","data-bs-dismiss":"modal",children:"取消"}),e.jsx("button",{type:"button",className:"btn btn-danger",onClick:r,"data-bs-dismiss":"modal",children:"確認刪除"})]})]})})})}function R({products:c,pageSize:l,currentPage:u,setCurrentPage:m,pagination:x,onPageChange:r}){const s=x?.total_pages||Math.ceil(c.length/l)||0,d=[];for(let n=1;n<=s;n++)d.push(n);return e.jsx("div",{children:e.jsx("nav",{children:e.jsx("ul",{className:"pagination justify-content-center",children:d.map(n=>e.jsx("li",{className:"page-item "+(n===u?"active":""),children:e.jsx("a",{className:"page-link",href:"#",onClick:j=>{j.preventDefault(),n!==u&&(m(n),r&&r(n))},children:n})},n))})})})}const $="https://ec-course-api.hexschool.io/v2",H="kentlee406";function Q(){const c=L(),{showLoading:l,hideLoading:u}=o.useContext(A),{showNotification:m}=P(),[x,r]=o.useState(1),[s,d]=o.useState([]),[n,j]=o.useState({}),[v,y]=o.useState(""),[f,g]=o.useState({id:"",imageUrl:"",title:"",category:"",unit:"",origin_price:"",price:"",description:"",content:"",is_enabled:!1,imagesUrl:[]}),h=(a,t)=>{y(a),g(a==="create"?{title:"",category:"",unit:"",origin_price:0,price:0,description:"",content:"",is_enabled:0,imageUrl:"",imagesUrl:[""]}:t);const i=document.getElementById("ProductModal");E.getOrCreateInstance(i).show()},N=async(a=x)=>{try{l();const t=await p.get(`${$}/api/${H}/admin/products?page=${a}`);d(t.data.products),j(t.data.pagination),r(t.data.pagination.current_page)}catch{m("取得後台產品資料失敗，請稍後再試","error",8e3)}finally{u()}},k=()=>document.cookie.split("; ").find(a=>a.startsWith("hexToken="))?.split("=")[1],I=async()=>{const a=k();if(!a){m("登入狀態已失效，請重新登入","error",8e3),c("/login");return}try{l(),p.defaults.headers.common.Authorization=a,await p.post(`${$}/api/user/check`),await N(1)}catch{p.defaults.headers.common.Authorization="",m("登入狀態已失效，請重新登入","error",8e3),c("/login")}finally{u()}},C=async()=>{try{l(),await p.post(`${$}/logout`),document.cookie="hexToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;",p.defaults.headers.common.Authorization="",c("/login")}catch{m("登出失敗，請稍後再試","error",8e3)}finally{u()}};return o.useEffect(()=>{I()},[]),e.jsxs("div",{className:"container",children:[e.jsx("div",{className:"row justify-content-center",children:e.jsxs("div",{className:"col-8",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsx("h2",{className:"fw-bold",children:"產品列表"}),e.jsxs("div",{children:[e.jsx("button",{className:"btn btn-success me-2",onClick:()=>h("create"),children:"新增產品"}),e.jsx("button",{className:"btn btn-danger",onClick:C,children:"登出"})]})]}),e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"分類"}),e.jsx("th",{children:"產品名稱"}),e.jsx("th",{children:"原價"}),e.jsx("th",{children:"售價"}),e.jsx("th",{children:"是否啟用"}),e.jsx("th",{children:"編輯"}),e.jsx("th",{children:"刪除"})]})}),e.jsx("tbody",{children:s&&s.length>0?s.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.category}),e.jsx("td",{children:a.title}),e.jsx("td",{children:a.origin_price}),e.jsx("td",{children:a.price}),e.jsx("td",{children:a.is_enabled?"啟用":"未啟用"}),e.jsx("td",{children:e.jsx("button",{className:"btn btn-primary",onClick:()=>h("edit",a),children:"編輯"})}),e.jsx("td",{children:e.jsx("button",{type:"button",className:"btn btn-danger",id:"delete"+a.id,onClick:()=>g(a),"data-bs-target":"#deleteModal","data-bs-toggle":"modal",children:"刪除"})})]},a.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:"7",children:"尚無產品資料"})})})]})]})}),e.jsx(R,{products:s,pagination:n,currentPage:x,setCurrentPage:r,onPageChange:N}),e.jsx(D,{mode:v,tempProduct:f,getProductData:N}),e.jsx(B,{getProductData:N,tempProduct:f})]})}export{Q as default};
